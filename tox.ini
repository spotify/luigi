[tox]
requires =
    tox>=4.22 # `dependency_groups` needed
    tox-uv>=1.19
envlist = py{38,39,310,311,312}-{cdh,hdp,core,contrib,apache,aws,gcloud,mysql,postgres,unixsocket,azureblob,dropbox}, visualiser, docs, flake8, stubtest
skipsdist = True

[pytest]
addopts = --cov=luigi --cov-report=xml -vv --strict-markers --ignore-glob="**/_*" --fulltrace
testpaths = test
markers =
    contrib: tests related to luigi/contrib
    apache: tests related to apache
    aws: tests related to AWS
    postgres: tests related to postgresql
    mysql: tests related to mysql
    scheduler: tests related to scheduler
    cdh: tests related to cdh
    hdp: tests related to hdp
    gcloud: tests related to GCP
    unixsocket: tests related to unixsocket
    dropbox: tests related to dropbox
    azureblob: tests related to azure
    unmarked: tests with no explicit markers
filterwarnings =
  default
  ignore:.*outputs has no custom.*:UserWarning

[testenv]
runner = uv-venv-lock-runner
allowlist_externals = {toxinidir}/scripts/ci/*.sh
dependency_groups =
    core: common
    contrib: common
    apache: common
    aws: common
    postgres: test_postgres
    mysql: common
    scheduler: common
    cdh: test_cdh
    hdp: test_hdp
    gcloud: test_gcloud
    unixsocket: test_unixsocket
    dropbox: test_dropbox
    azureblob: common
passenv = USER, JAVA_HOME, POSTGRES_USER, DATAPROC_TEST_PROJECT_ID, GCS_TEST_PROJECT_ID, GCS_TEST_BUCKET, GOOGLE_APPLICATION_CREDENTIALS, CI, DROPBOX_APP_TOKEN, DOCKERHUB_TOKEN, GITHUB_ACTIONS, OVERRIDE_SKIP_CI_TESTS
setenv =
    LC_ALL = en_US.utf-8
    cdh: HADOOP_DISTRO=cdh
    cdh: HADOOP_HOME={toxinidir}/.tox/hadoop-cdh
    hdp: HADOOP_DISTRO=hdp
    hdp: HADOOP_HOME={toxinidir}/.tox/hadoop-hdp
    LUIGI_CONFIG_PATH={toxinidir}/test/testconfig/luigi.cfg
    COVERAGE_PROCESS_START={toxinidir}/.coveragerc
    FULL_COVERAGE=true
    AWS_DEFAULT_REGION=us-east-1
    AWS_ACCESS_KEY_ID=accesskey
    AWS_SECRET_ACCESS_KEY=secretkey
    AZURITE_ACCOUNT_NAME=devstoreaccount1
    AZURITE_ACCOUNT_KEY=YXp1cml0ZQ==
    AZURITE_CUSTOM_DOMAIN=localhost:10000
commands =
    # Setup
    cdh,hdp: {toxinidir}/scripts/ci/setup_hadoop_env.sh
    azureblob: {toxinidir}/scripts/ci/install_start_azurite.sh {toxinidir}/scripts/ci
    {envpython} --version
    # Test
    contrib: {envpython} -m pytest test/contrib/ -m "contrib or unmarked" {posargs:}
    apache: {envpython} -m pytest -m apache {posargs:}
    aws: {envpython} -m pytest -m aws {posargs:}
    mysql: {envpython} -m pytest -m mysql {posargs:}
    postgres: {envpython} -m pytest -m postgres {posargs:}
    scheduler: {envpython} -m pytest -m scheduler {posargs:}
    cdh,hdp: {envpython} -m pytest -m minicluster {posargs:}
    gcloud: {envpython} -m pytest -m gcloud {posargs:}
    unixsocket: {envpython} -m pytest -m unixsocket {posargs:}
    dropbox: {envpython} -m pytest -m dropbox {posargs:}
    azureblob: {envpython} -m pytest -m azureblob {posargs:}
    core: {envpython} -m pytest --doctest-modules --ignore=test/contrib/ -m "not unixsocket" {posargs:}
    # Teardown
    azureblob: {toxinidir}/scripts/ci/stop_azurite.sh

[testenv:visualiser]
runner = uv-venv-lock-runner
dependency_groups = visualizer
passenv = {[testenv]passenv}
setenv =
    LC_ALL = en_US.utf-8
    LUIGI_CONFIG_PATH={toxinidir}/test/testconfig/luigi.cfg
    TEST_VISUALISER=1
commands =
    python --version
    pytest test/visualiser

# Flake8 Configuration, inspired from https://gitlab.com/pycqa/flake8/blob/master/tox.ini
# By putting it here, local flake8 runs will also pick it up.
[flake8]
max-line-length = 160
builtins = unicode

[testenv:flake8]
dependency_groups = lint
commands =
    flake8 --exclude=doc,.tox,.venv
    flake8 --max-line-length=100 --ignore=E265 doc

[testenv:isort]
dependency_groups = lint
commands = isort -w 120 -rc luigi test examples bin

[testenv:docs]
# need Python 3.10
basepython = py310
# Build documentation using sphinx.
# Call this using `tox run -e docs`.
dependency_groups = docs
commands =
# build API docs
    sphinx-apidoc -o doc/api -T luigi --separate

# build HTML docs
    sphinx-build -W -b html -d {envtmpdir}/doctrees doc doc/_build/html

[testenv:stubtest]
# Validate stub files against implementation
dependency_groups = common
commands =
    python -m mypy.stubtest luigi.parameter --allowlist test/stubtest-allowlist.txt
